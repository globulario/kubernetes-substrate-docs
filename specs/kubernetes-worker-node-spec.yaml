# Kubernetes Worker Node Package Spec
# This package installs K8s worker node components that join the substrate cluster.
#
# Substrate Dependencies (provided by Globular Layer 0):
# - Identity and certificates from Globular CA
# - DNS resolution via Globular DNS
# - Service discovery (finds API server automatically)
# - Network connectivity via Globular networking
#
# What This Package Installs:
# - kubelet (pod lifecycle manager)
# - kube-proxy (network proxy)
# - Container runtime (containerd)
#
# What This Package Does NOT Manage:
# - Node provisioning (Globular owns this)
# - Network configuration (Globular networking)
# - Certificate authority (Globular owns this)

metadata:
  name: kubernetes-worker-node
  version: "1.29.2"
  description: "Kubernetes worker node running on Globular substrate"
  dependencies:
    - dns
    - tls-infrastructure
    - service-discovery
    - container-runtime
  keywords:
    - kubernetes
    - k8s
    - worker
    - kubelet
    - node

steps:
  # -----------------------------------------------------------------------------
  # 1. Ensure kubernetes user exists
  # -----------------------------------------------------------------------------
  - id: ensure-kubernetes-user
    type: ensure_user_group
    user: kubernetes
    group: kubernetes
    description: "System user for Kubernetes node"

  # -----------------------------------------------------------------------------
  # 2. Create directories
  # -----------------------------------------------------------------------------
  - id: ensure-kubelet-dirs
    type: ensure_dirs
    directories:
      - path: /var/lib/kubelet
        owner: root
        group: root
        mode: "0750"
      - path: /var/lib/kubelet/pki
        owner: root
        group: root
        mode: "0750"
      - path: /etc/kubernetes
        owner: root
        group: root
        mode: "0755"
      - path: /var/log/pods
        owner: root
        group: root
        mode: "0755"
      - path: /opt/cni/bin
        owner: root
        group: root
        mode: "0755"

  # -----------------------------------------------------------------------------
  # 3. Install binaries
  # -----------------------------------------------------------------------------
  - id: install-kubelet-binaries
    type: install_package_payload
    install_config: false
    binaries:
      - name: kubelet
        destination: /usr/lib/globular/bin/kubelet
        mode: "0755"
      - name: kube-proxy
        destination: /usr/lib/globular/bin/kube-proxy
        mode: "0755"

  # -----------------------------------------------------------------------------
  # 4. Generate node certificates using Globular CA
  # -----------------------------------------------------------------------------
  - id: install-node-cert-generation
    type: install_files
    files:
      - path: /usr/lib/globular/scripts/kubelet-generate-certs.sh
        mode: "0755"
        content: |
          #!/bin/bash
          # Generate kubelet certificates using Globular's CA
          # Node identity is established by substrate before K8s joins

          set -euo pipefail

          GLOBULAR_CA_CERT="/var/lib/globular/pki/ca.crt"
          GLOBULAR_CA_KEY="/var/lib/globular/pki/ca.key"
          KUBELET_PKI_DIR="/var/lib/kubelet/pki"
          NODE_HOSTNAME=$(hostname -f)

          # Convergent: skip if certs already exist
          if [[ -f "${KUBELET_PKI_DIR}/kubelet.crt" ]]; then
            echo "Kubelet certificates already exist"
            exit 0
          fi

          echo "Generating kubelet certificates for node: ${NODE_HOSTNAME}"

          # Generate kubelet certificate
          openssl req -new -newkey rsa:2048 -nodes \
            -keyout "${KUBELET_PKI_DIR}/kubelet.key" \
            -out "${KUBELET_PKI_DIR}/kubelet.csr" \
            -subj "/CN=system:node:${NODE_HOSTNAME}/O=system:nodes"

          openssl x509 -req -in "${KUBELET_PKI_DIR}/kubelet.csr" \
            -CA "${GLOBULAR_CA_CERT}" -CAkey "${GLOBULAR_CA_KEY}" -CAcreateserial \
            -out "${KUBELET_PKI_DIR}/kubelet.crt" -days 365 \
            -extensions v3_req -extfile <(cat <<EOF
          [v3_req]
          basicConstraints = CA:FALSE
          keyUsage = nonRepudiation, digitalSignature, keyEncipherment
          extendedKeyUsage = serverAuth, clientAuth
          subjectAltName = @alt_names
          [alt_names]
          DNS.1 = ${NODE_HOSTNAME}
          DNS.2 = $(hostname -s)
          IP.1 = $(hostname -I | awk '{print $1}')
          EOF
          )

          # Symlink to Globular CA
          ln -sf "${GLOBULAR_CA_CERT}" "${KUBELET_PKI_DIR}/ca.crt"

          chmod 600 "${KUBELET_PKI_DIR}/kubelet.key"
          echo "Kubelet certificates generated"

  # -----------------------------------------------------------------------------
  # 5. Discover API server from Globular service registry
  # -----------------------------------------------------------------------------
  - id: install-apiserver-discovery
    type: install_files
    files:
      - path: /usr/lib/globular/scripts/discover-k8s-apiserver.sh
        mode: "0755"
        content: |
          #!/bin/bash
          # Discover Kubernetes API server via Globular's service discovery
          # No hardcoded endpoints - substrate provides the truth

          set -euo pipefail

          DISCOVERY_ENDPOINT="https://127.0.0.1:10016"
          OUTPUT_FILE="/etc/kubernetes/apiserver-endpoint"

          # Query Globular's discovery service for K8s API server
          API_SERVER=$(curl -sf \
            --cacert /var/lib/globular/config/tls/ca.pem \
            --cert /var/lib/globular/config/tls/server.crt \
            --key /var/lib/globular/config/tls/server.key \
            "${DISCOVERY_ENDPOINT}/api/services/kubernetes.KubernetesService" \
            | jq -r '.address' || echo "")

          if [[ -z "${API_SERVER}" ]]; then
            echo "ERROR: Could not discover Kubernetes API server"
            echo "Is the control plane installed and running?"
            exit 1
          fi

          echo "Discovered API server at: ${API_SERVER}"
          echo "https://${API_SERVER}" > "${OUTPUT_FILE}"

  # -----------------------------------------------------------------------------
  # 6. Install kubelet configuration
  # -----------------------------------------------------------------------------
  - id: install-kubelet-config
    type: install_files
    files:
      - path: /etc/kubernetes/kubelet-config.yaml
        owner: root
        group: root
        mode: "0644"
        content: |
          apiVersion: kubelet.config.k8s.io/v1beta1
          kind: KubeletConfiguration

          # Authentication (using Globular substrate identity)
          authentication:
            anonymous:
              enabled: false
            webhook:
              enabled: true
            x509:
              clientCAFile: /var/lib/kubelet/pki/ca.crt

          # Authorization
          authorization:
            mode: Webhook

          # TLS
          tlsCertFile: /var/lib/kubelet/pki/kubelet.crt
          tlsPrivateKeyFile: /var/lib/kubelet/pki/kubelet.key

          # Cluster DNS (Globular DNS)
          clusterDNS:
            - 10.96.0.10      # K8s CoreDNS service IP
            - 127.0.0.1       # Fallback to Globular DNS

          clusterDomain: cluster.local

          # Container runtime
          containerRuntimeEndpoint: unix:///run/containerd/containerd.sock

          # Resource management
          cpuManagerPolicy: none
          memoryManagerPolicy: None
          maxPods: 110

          # Logging
          logging:
            format: json

          # Health
          healthzBindAddress: 0.0.0.0
          healthzPort: 10248

  # -----------------------------------------------------------------------------
  # 7. Install kubelet systemd service
  # -----------------------------------------------------------------------------
  - id: install-kubelet-service
    type: install_services
    services:
      - name: kubelet
        content: |
          [Unit]
          Description=Kubernetes Kubelet
          Documentation=https://kubernetes.io/docs/concepts/overview/components/#kubelet
          After=network.target containerd.service
          Requires=containerd.service

          [Service]
          Type=simple

          # Generate certificates using Globular CA (convergent)
          ExecStartPre=/usr/lib/globular/scripts/kubelet-generate-certs.sh

          # Discover API server from Globular service registry
          ExecStartPre=/usr/lib/globular/scripts/discover-k8s-apiserver.sh

          ExecStart=/usr/lib/globular/bin/kubelet \
            --config=/etc/kubernetes/kubelet-config.yaml \
            --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
            --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubeconfig \
            --cert-dir=/var/lib/kubelet/pki \
            --hostname-override=$(hostname -f) \
            --pod-infra-container-image=registry.k8s.io/pause:3.9 \
            --v=2

          Restart=always
          RestartSec=10
          KillMode=process

          # Resource limits
          LimitNOFILE=65536
          LimitNPROC=4096

          [Install]
          WantedBy=multi-user.target

  # -----------------------------------------------------------------------------
  # 8. Install kube-proxy configuration
  # -----------------------------------------------------------------------------
  - id: install-kube-proxy-config
    type: install_files
    files:
      - path: /etc/kubernetes/kube-proxy-config.yaml
        owner: root
        group: root
        mode: "0644"
        content: |
          apiVersion: kubeproxy.config.k8s.io/v1alpha1
          kind: KubeProxyConfiguration

          bindAddress: 0.0.0.0
          clientConnection:
            kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig

          clusterCIDR: 10.244.0.0/16

          # Use iptables mode (most compatible)
          mode: iptables

          # Health
          healthzBindAddress: 0.0.0.0:10256

  # -----------------------------------------------------------------------------
  # 9. Install kube-proxy systemd service
  # -----------------------------------------------------------------------------
  - id: install-kube-proxy-service
    type: install_services
    services:
      - name: kube-proxy
        content: |
          [Unit]
          Description=Kubernetes Kube Proxy
          Documentation=https://kubernetes.io/docs/concepts/overview/components/#kube-proxy
          After=network.target kubelet.service
          Requires=kubelet.service

          [Service]
          Type=simple

          ExecStart=/usr/lib/globular/bin/kube-proxy \
            --config=/etc/kubernetes/kube-proxy-config.yaml \
            --v=2

          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

  # -----------------------------------------------------------------------------
  # 10. Install bootstrap kubeconfig (for initial join)
  # -----------------------------------------------------------------------------
  - id: install-bootstrap-kubeconfig
    type: install_files
    files:
      - path: /etc/kubernetes/bootstrap-kubeconfig
        owner: root
        group: root
        mode: "0600"
        content: |
          # Bootstrap kubeconfig for node joining
          # Uses TLS bootstrapping to get node-specific credentials

          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              certificate-authority: /var/lib/kubelet/pki/ca.crt
              server: $(cat /etc/kubernetes/apiserver-endpoint)
            name: kubernetes
          contexts:
          - context:
              cluster: kubernetes
              user: kubelet-bootstrap
            name: kubelet-bootstrap@kubernetes
          current-context: kubelet-bootstrap@kubernetes
          users:
          - name: kubelet-bootstrap
            user:
              token: $(cat /var/lib/globular/secrets/k8s-bootstrap-token)

  # -----------------------------------------------------------------------------
  # 11. Enable and start services
  # -----------------------------------------------------------------------------
  - id: enable-node-services
    type: enable_services
    services:
      - kubelet
      - kube-proxy

  - id: start-node-services
    type: start_services
    services:
      - kubelet
      - kube-proxy

  # -----------------------------------------------------------------------------
  # 12. Health checks
  # -----------------------------------------------------------------------------
  - id: health-check-kubelet
    type: health_checks
    checks:
      - name: kubelet-health
        type: http
        url: http://127.0.0.1:10248/healthz
        timeout: 5s
        expected_status: 200
        description: "Verify kubelet health endpoint"

      - name: kube-proxy-health
        type: http
        url: http://127.0.0.1:10256/healthz
        timeout: 5s
        expected_status: 200
        description: "Verify kube-proxy health endpoint"

  # -----------------------------------------------------------------------------
  # 13. Register node with Globular service discovery
  # -----------------------------------------------------------------------------
  - id: register-node-with-discovery
    type: install_files
    files:
      - path: /usr/lib/globular/scripts/register-k8s-node.sh
        mode: "0755"
        content: |
          #!/bin/bash
          # Register K8s node with Globular's service discovery
          # Makes node visible to substrate monitoring

          set -euo pipefail

          NODE_HOSTNAME=$(hostname -f)
          NODE_IP=$(hostname -I | awk '{print $1}')

          curl -X POST https://127.0.0.1:10016/api/register \
            --cacert /var/lib/globular/config/tls/ca.pem \
            --cert /var/lib/globular/config/tls/server.crt \
            --key /var/lib/globular/config/tls/server.key \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"kubelet.${NODE_HOSTNAME}\",
              \"domain\": \"localhost\",
              \"address\": \"${NODE_IP}:10250\",
              \"protocol\": \"https\",
              \"version\": \"1.29.2\",
              \"state\": \"running\",
              \"description\": \"Kubernetes worker node\"
            }" || echo "Warning: Failed to register with discovery"

          echo "Node ${NODE_HOSTNAME} registered with Globular"

notes: |
  Kubernetes Worker Node Installed Successfully

  The node has joined the cluster and is ready for workloads.

  Integration with Globular substrate:
  ✓ Node identity: Certificate from Globular CA
  ✓ API server discovery: Found via Globular service registry
  ✓ DNS resolution: Using Globular DNS (127.0.0.1:53)
  ✓ Health monitoring: Registered with Globular
  ✓ Certificate rotation: Managed by Globular TLS system

  Verify node status:
    kubectl --kubeconfig=/etc/kubernetes/admin.kubeconfig get nodes

  Expected output:
    NAME              STATUS   ROLES    AGE   VERSION
    worker-01         Ready    <none>   1m    v1.29.2

  Node is now ready to receive pod scheduling from the control plane.

  What happens automatically:
  - Kubelet registers with API server (TLS bootstrap)
  - Node appears in cluster (kubectl get nodes)
  - Pods can be scheduled to this node
  - Globular monitors node health
  - Certificate auto-rotates before expiry

  "Infrastructure truth (Globular) + Workload truth (K8s) = Boring reliability"
